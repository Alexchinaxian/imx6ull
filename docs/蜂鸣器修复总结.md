# èœ‚é¸£å™¨åŠç‚¹æé†’ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°

TimeServiceçš„åŠç‚¹/æ•´ç‚¹èœ‚é¸£æç¤ºä¸ç”Ÿæ•ˆï¼Œä½†SystemBeepçš„å¼€å…³æœºæç¤ºéŸ³å¯ä»¥æ­£å¸¸å·¥ä½œã€‚

## æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜1ï¼šç¼ºå°‘`isAvailable()`æ£€æŸ¥
- **TimeService** å’Œ **AlarmService** åªæ£€æŸ¥äº†`m_pBeep != nullptr`
- æ²¡æœ‰æ£€æŸ¥`m_pBeep->isAvailable()`ï¼Œå¯¼è‡´è®¾å¤‡ä¸å¯ç”¨æ—¶ä»ç„¶å°è¯•è°ƒç”¨
- **SystemBeep** æ­£ç¡®å®ç°äº†å®Œæ•´æ£€æŸ¥ï¼š`m_enabled && m_beepDriver && m_beepDriver->isAvailable()`

### é—®é¢˜2ï¼šä¾èµ–å…³ç³»å»ºç«‹æ—¶æœºé”™è¯¯  
- åŸæµç¨‹ï¼š
  1. `SvrCreateInit()` â†’ åˆ›å»ºæ‰€æœ‰æœåŠ¡
  2. `SvrCreateInit()` â†’è°ƒç”¨ `SetupServiceDependencies()` âŒ
  3. `SvrInit()` â†’ åˆå§‹åŒ–æ‰€æœ‰æœåŠ¡  
  4. `SvrStart()` â†’ å¯åŠ¨æœåŠ¡ï¼ˆ**TimeServiceåœ¨è¿™é‡Œæ£€æŸ¥m_pBeepï¼Œä½†è¿˜æ˜¯nullptr**ï¼‰

- ä¿®å¤åæµç¨‹ï¼š
  1. `SvrCreateInit()` â†’ åˆ›å»ºæ‰€æœ‰æœåŠ¡
  2. `SvrInit()` â†’ åˆå§‹åŒ–æ‰€æœ‰æœåŠ¡
  3. `SvrInit()` â†’ è°ƒç”¨ `SetupServiceDependencies()` âœ…  
  4. `SvrStart()` â†’ å¯åŠ¨æœåŠ¡ï¼ˆ**æ­¤æ—¶m_pBeepå·²æ­£ç¡®è®¾ç½®**ï¼‰

## ä¿®å¤å†…å®¹

### 1. TimeService.cpp - æ·»åŠ è®¾å¤‡å¯ç”¨æ€§æ£€æŸ¥

**ä½ç½®**ï¼š`src/services/time/TimeService.cpp:242-243`

```cpp
// ä¿®å¤å‰
if (m_halfHourBeepEnabled && m_pBeep) {
    m_pBeep->beep(1, 300);
}

// ä¿®å¤å  
if (m_halfHourBeepEnabled && m_pBeep && m_pBeep->isAvailable()) {
    m_pBeep->beep(1, 300);
}
```

**åŒæ—¶æ·»åŠ **è¯¦ç»†çš„è¯Šæ–­æ—¥å¿—ï¼š
```cpp
if (!m_pBeep->isAvailable()) {
    LOG_WARNING("Time", "èœ‚é¸£å™¨è®¾å¤‡ä¸å¯ç”¨ï¼š/sys/class/leds/beep ä¸å­˜åœ¨");
}
```

### 2. AlarmService.cpp - æ·»åŠ è®¾å¤‡å¯ç”¨æ€§æ£€æŸ¥

**ä½ç½®**ï¼š`src/services/alarm/AlarmService.cpp:292-295`ã€`319-322`ã€`268`

```cpp
// æ’­æ”¾èµ·åºŠé—¹é’Ÿ
if (!m_pBeep->isAvailable()) {
    LOG_WARNING("Alarm", "èœ‚é¸£å™¨è®¾å¤‡ä¸å¯ç”¨ï¼š/sys/class/leds/beep ä¸å­˜åœ¨");
    return;
}

// æ’­æ”¾ç¡çœ æç¤º
if (!m_pBeep->isAvailable()) {
    LOG_WARNING("Alarm", "èœ‚é¸£å™¨è®¾å¤‡ä¸å¯ç”¨ï¼š/sys/class/leds/beep ä¸å­˜åœ¨");
    return;
}

// å®šæ—¶æ’­æ”¾
if (m_pBeep && m_pBeep->isAvailable()) {
    m_pBeep->beep(2, 150);
}
```

### 3. DriverBeep.cpp - é©±åŠ¨å±‚é˜²å¾¡æ€§æ£€æŸ¥

**ä½ç½®**ï¼š`src/drivers/beep/DriverBeep.cpp:115-119`ã€`144-147`

```cpp
// beep()æ–¹æ³•
if (!isAvailable()) {
    qWarning() << "[DriverBeep] è®¾å¤‡ä¸å¯ç”¨ï¼Œå¿½ç•¥èœ‚é¸£è¯·æ±‚:" << m_sysfsPath;
    return;
}

// alarm()æ–¹æ³•  
if (!isAvailable()) {
    qWarning() << "[DriverBeep] è®¾å¤‡ä¸å¯ç”¨ï¼Œå¿½ç•¥æŠ¥è­¦è¯·æ±‚:" << m_sysfsPath;
    return;
}
```

### 4. ServiceManager.cpp - è°ƒæ•´ä¾èµ–å…³ç³»å»ºç«‹æ—¶æœº â­

**å…³é”®ä¿®å¤**ï¼š

**ä½ç½®1**ï¼š`src/core/ServiceManager.cpp:177-180`
```cpp
// SvrInit()æ–¹æ³•ä¸­æ·»åŠ 
// å»ºç«‹æœåŠ¡é—´çš„ä¾èµ–å…³ç³»ï¼ˆåœ¨åˆå§‹åŒ–å®Œæˆåã€å¯åŠ¨ä¹‹å‰ï¼‰
qInfo() << "[ServiceManager] å»ºç«‹æœåŠ¡é—´ä¾èµ–å…³ç³»...";
SetupServiceDependencies();
qInfo() << "[ServiceManager] âœ“ ä¾èµ–å…³ç³»å»ºç«‹å®Œæˆ";
```

**ä½ç½®2**ï¼š`src/core/ServiceManager.cpp:384`
```cpp
// ä»SvrCreateInit()ä¸­ç§»é™¤
// å»ºç«‹æœåŠ¡é—´çš„ä¾èµ–å…³ç³»
SetupServiceDependencies();  // âŒ åˆ é™¤è¿™è¡Œ

// æ”¹ä¸ºæ³¨é‡Šè¯´æ˜
// æ³¨æ„ï¼šä¾èµ–å…³ç³»å°†åœ¨SvrInit()ä¸­å»ºç«‹ï¼ˆæ‰€æœ‰æœåŠ¡åˆå§‹åŒ–å®Œæˆåï¼‰
```

### 5. TimeService.cpp - æµ‹è¯•æ¨¡å¼ï¼šæ¯åˆ†é’Ÿè§¦å‘

**ä½ç½®**ï¼š`src/services/time/TimeService.cpp:240-280`

```cpp
// æµ‹è¯•æ¨¡å¼ï¼šæ¯åˆ†é’Ÿè§¦å‘èœ‚é¸£
// TODO: æ¢å¤ç”Ÿäº§æ¨¡å¼æ—¶æ”¹ä¸º if (currentMinute == 0 || currentMinute == 30)
if (true) {  // æµ‹è¯•æ¨¡å¼ï¼šæ¯åˆ†é’Ÿè§¦å‘
    if (m_halfHourBeepEnabled && m_pBeep && m_pBeep->isAvailable()) {
        // ...
        if (currentMinute == 0) {
            LOG_INFO("Time", QString("ğŸ• æ•´ç‚¹æŠ¥æ—¶: %1 (èœ‚é¸£2æ¬¡)").arg(timeStr));
            m_pBeep->beep(2, 300);
        } else if (currentMinute == 30) {
            LOG_INFO("Time", QString("ğŸ•‘ åŠç‚¹æé†’: %1 (èœ‚é¸£1æ¬¡)").arg(timeStr));
            m_pBeep->beep(1, 300);
        } else {
            LOG_INFO("Time", QString("â° åˆ†é’Ÿæé†’: %1 (æµ‹è¯•èœ‚é¸£)").arg(timeStr));
            m_pBeep->beep(1, 150);  // æµ‹è¯•ï¼š1æ¬¡çŸ­ä¿ƒèœ‚é¸£
        }
    }
}
```

## æµ‹è¯•éªŒè¯

### 1. å¼€å‘æ¿èœ‚é¸£å™¨è®¾å¤‡çŠ¶æ€
```bash
$ ssh root@192.168.1.24 'ls -la /sys/class/leds/beep/'
drwxr-xr-x 3 root root    0 Jul 23  2021 .
-rw-rw-rw- 1 root root 4096 Oct 15 22:00 brightness  âœ…
```

### 2. æ‰‹åŠ¨æµ‹è¯•èœ‚é¸£å™¨
```bash
$ ssh root@192.168.1.24 'echo 255 > /sys/class/leds/beep/brightness && sleep 0.3 && echo 0 > /sys/class/leds/beep/brightness'
âœ… èœ‚é¸£å™¨å·¥ä½œæ­£å¸¸
```

### 3. ç¨‹åºè¿è¡ŒçŠ¶æ€
```bash
$ ssh root@192.168.1.24 'ps aux | grep QtImx6ull'
root      2376  ./QtImx6ullBackend  âœ… è¿è¡Œä¸­
```

### 4. é¢„æœŸæ—¥å¿—è¾“å‡ºï¼ˆä¿®å¤åï¼‰
```
[ServiceManager] å»ºç«‹æœåŠ¡é—´ä¾èµ–å…³ç³»...
  âœ“ æ—¶é—´æœåŠ¡ <-> Beepé©±åŠ¨ ä¾èµ–å…³ç³»å·²å»ºç«‹
  âœ“ é—¹é’ŸæœåŠ¡ <-> Beepé©±åŠ¨ ä¾èµ–å…³ç³»å·²å»ºç«‹
[ServiceManager] âœ“ ä¾èµ–å…³ç³»å»ºç«‹å®Œæˆ

[Time] å¯åŠ¨æ—¶é—´æœåŠ¡...
[Time] âœ“ èœ‚é¸£å™¨è®¾å¤‡å¯ç”¨
[Time] âœ“ åŠç‚¹æé†’å®šæ—¶å™¨å¯åŠ¨

[Alarm] å¯åŠ¨é—¹é’ŸæœåŠ¡...
[Alarm] âœ“ èœ‚é¸£å™¨è®¾å¤‡å¯ç”¨
[Alarm] âœ“ é—¹é’Ÿå®šæ—¶å™¨å¯åŠ¨

[Time] â° åˆ†é’Ÿæé†’: 2025-10-15 22:07:00 (æµ‹è¯•èœ‚é¸£)
[Time] â° åˆ†é’Ÿæé†’: 2025-10-15 22:08:00 (æµ‹è¯•èœ‚é¸£)
```

## æ¢å¤ç”Ÿäº§æ¨¡å¼

æµ‹è¯•å®Œæˆåï¼Œéœ€è¦å°†TimeServiceæ¢å¤ä¸ºåŠç‚¹æé†’æ¨¡å¼ï¼š

```cpp
// src/services/time/TimeService.cpp:242
// å°† if (true) æ”¹ä¸ºï¼š
if (currentMinute == 0 || currentMinute == 30) {
    // åªåœ¨æ•´ç‚¹å’ŒåŠç‚¹è§¦å‘
}
```

## æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶
- âœ… `src/services/time/TimeService.cpp` - æ·»åŠ isAvailable()æ£€æŸ¥ + æµ‹è¯•æ¨¡å¼
- âœ… `src/services/alarm/AlarmService.cpp` - æ·»åŠ isAvailable()æ£€æŸ¥  
- âœ… `src/drivers/beep/DriverBeep.cpp` - é©±åŠ¨å±‚é˜²å¾¡æ€§æ£€æŸ¥
- âœ… `src/core/ServiceManager.cpp` - **è°ƒæ•´ä¾èµ–å…³ç³»å»ºç«‹æ—¶æœº**
- âœ… `CMakeLists.txt` - æ·»åŠ AlarmServiceæºæ–‡ä»¶
- âœ… `download.sh` - ä¿®æ­£buildç›®å½•è·¯å¾„

### æ–°å¢æ–‡æ¡£
- âœ… `docs/åŠç‚¹å“beepé—®é¢˜è¯Šæ–­.md` - é—®é¢˜è¯Šæ–­æŠ¥å‘Š
- âœ… `docs/èœ‚é¸£å™¨ä¿®å¤æ€»ç»“.md` - æœ¬æ–‡æ¡£

## æœ€ä½³å®è·µ

### 1. è®¾å¤‡å¯ç”¨æ€§æ£€æŸ¥æ¨¡å¼
```cpp
if (m_driver && m_driver->isAvailable()) {
    // ä½¿ç”¨é©±åŠ¨
} else {
    LOG_WARNING("Module", "é©±åŠ¨ä¸å¯ç”¨");
}
```

### 2. æœåŠ¡ä¾èµ–å…³ç³»å»ºç«‹æ—¶æœº
```
åˆ›å»º(Create) â†’ åˆå§‹åŒ–(Init) â†’ å»ºç«‹ä¾èµ–(Setup) â†’ å¯åŠ¨(Start)
```

### 3. é©±åŠ¨å±‚é˜²å¾¡æ€§ç¼–ç¨‹
```cpp
void Driver::operation() {
    if (!isAvailable()) {
        qWarning() << "è®¾å¤‡ä¸å¯ç”¨";
        return;
    }
    // æ‰§è¡Œæ“ä½œ
}
```

## ä¸‹ä¸€æ­¥

1. âœ… ç¼–è¯‘éƒ¨ç½²åˆ°å¼€å‘æ¿
2. â³ è§‚å¯Ÿæ¯åˆ†é’Ÿçš„èœ‚é¸£æé†’
3. â³ ç¡®è®¤æ—¥å¿—è¾“å‡ºæ­£ç¡®
4. â³ æµ‹è¯•å®Œæˆåæ¢å¤åŠç‚¹æ¨¡å¼
5. â³ æµ‹è¯•é—¹é’ŸæœåŠ¡çš„èµ·åºŠé—¹é’Ÿå’Œç¡çœ æç¤º

---

**ä¿®å¤æ—¥æœŸ**: 2025-10-15  
**ä¿®å¤äººå‘˜**: Alex  
**æµ‹è¯•çŠ¶æ€**: å·²éƒ¨ç½²ï¼Œç­‰å¾…éªŒè¯

