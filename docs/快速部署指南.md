# IMX6ULL 项目快速部署指南

本文档介绍如何在新机器上快速部署和编译IMX6ULL项目。

## 🚀 一键部署（推荐）

如果你想快速开始，只需运行：

```bash
git clone <your-repo-url> imx6ull
cd imx6ull
chmod +x quick_setup.sh
./quick_setup.sh
```

这个脚本会自动完成：
1. ✅ 检查系统依赖
2. ✅ 安装交叉编译工具链（可选）
3. ✅ 验证Qt库
4. ✅ 配置项目
5. ✅ 编译项目

## 📋 系统要求

### 必需软件
- Ubuntu 16.04/18.04/20.04 或类似Linux发行版
- CMake 3.5+
- Make
- Git
- GCC/G++（主机编译器，用于构建工具）

### 磁盘空间
- 交叉编译工具链: ~3-5 GB
- Qt库（已包含在项目中）: ~47 MB
- 项目构建产物: ~50-100 MB
- **总计: 约 4-6 GB**

## 📦 分步部署指南

### 步骤1: 克隆项目

```bash
git clone <your-repo-url> imx6ull
cd imx6ull
```

项目已包含Qt5库，无需额外下载！

### 步骤2: 安装交叉编译工具链

#### 方法A: 使用自动安装脚本（推荐）

```bash
chmod +x setup_toolchain.sh
sudo ./setup_toolchain.sh
```

脚本会：
- 检查是否已安装
- 安装到 `/opt/fsl-imx-x11/4.1.15-2.1.0/`
- 配置环境变量
- 创建便捷命令

#### 方法B: 手动安装

1. 从NXP官网或提供的链接下载工具链
2. 运行安装程序：
   ```bash
   chmod +x fsl-imx-x11-glibc-x86_64-*.sh
   sudo ./fsl-imx-x11-glibc-x86_64-*.sh -d /opt/fsl-imx-x11/4.1.15-2.1.0/
   ```

3. 加载环境：
   ```bash
   source env-setup.sh
   ```

### 步骤3: 编译项目

```bash
# 创建构建目录
mkdir -p build-arm
cd build-arm

# 配置项目
cmake ..

# 编译（使用所有CPU核心）
make -j$(nproc)
```

编译成功后，可执行文件位于: `build-arm/bin/QtImx6ullBackend`

### 步骤4: 验证构建

```bash
# 返回项目根目录
cd ..

# 运行验证脚本
./verify_qt_libs.sh
```

验证脚本会检查：
- ✅ 可执行文件存在
- ✅ ARM架构正确
- ✅ RPATH配置
- ✅ Qt库依赖
- ✅ 路径解析

## 🔧 工具链环境管理

### 加载工具链环境

```bash
# 方法1: 使用快捷命令（如果运行了setup_toolchain.sh）
imx6ull-env

# 方法2: 使用项目环境脚本
source env-setup.sh

# 方法3: 使用系统环境文件
source /etc/profile.d/imx6ull-toolchain.sh
```

### 验证工具链

```bash
# 检查编译器
arm-poky-linux-gnueabi-gcc --version

# 检查环境变量
echo $CROSS_COMPILE
echo $SYSROOT_PATH
```

## 📁 项目结构

```
imx6ull/
├── CMakeLists.txt              # CMake配置
├── env-setup.sh                # 环境设置脚本
├── quick_setup.sh              # 一键部署脚本
├── setup_toolchain.sh          # 工具链安装脚本
├── copy_qt_libs.sh             # Qt库复制脚本
├── verify_qt_libs.sh           # 配置验证脚本
├── rebuild.sh                  # 快速重新编译
├── include/                    # 头文件
├── src/                        # 源代码
│   ├── core/                   # 核心层
│   ├── drivers/                # 驱动层
│   ├── services/               # 服务层
│   └── protocols/              # 协议层
├── third_party/                # 第三方库
│   └── qt5/                    # Qt5库（已包含）
│       ├── lib/                # Qt库文件
│       ├── include/            # Qt头文件
│       ├── cmake/              # CMake配置
│       └── plugins/            # Qt插件
├── build-arm/                  # ARM构建目录（.gitignore）
├── tools/                      # 工具脚本
└── docs/                       # 文档
```

## 🎯 常见任务

### 清理构建

```bash
rm -rf build-arm
```

### 重新编译

```bash
cd build-arm
make -j$(nproc)
```

或使用快速脚本：
```bash
./rebuild.sh
```

### 只编译特定目标

```bash
cd build-arm
make QtImx6ullBackend -j$(nproc)
```

### 查看编译详情

```bash
cd build-arm
make VERBOSE=1
```

## 🚢 部署到目标设备

### 打包部署文件

```bash
# 创建部署包
mkdir -p deploy
cp build-arm/bin/QtImx6ullBackend deploy/
cp -r third_party/qt5/lib deploy/
cp hardware.init deploy/

# 打包
tar -czf imx6ull-deploy.tar.gz deploy/
```

### 传输到设备

```bash
# 使用scp
scp imx6ull-deploy.tar.gz root@192.168.1.100:/home/root/

# 在设备上解压
ssh root@192.168.1.100
cd /home/root
tar -xzf imx6ull-deploy.tar.gz
cd deploy
```

### 在设备上运行

```bash
# 设置库路径
export LD_LIBRARY_PATH=$PWD/lib:$LD_LIBRARY_PATH

# 运行程序
./QtImx6ullBackend
```

## ⚠️ 故障排除

### 问题: 找不到Qt库

**解决方案:**
```bash
# 检查Qt库
ls -la third_party/qt5/lib/libQt5*.so.5

# 如果缺失，运行
./copy_qt_libs.sh
```

### 问题: 编译器未找到

**解决方案:**
```bash
# 检查工具链路径
ls -la /opt/fsl-imx-x11/4.1.15-2.1.0/

# 重新加载环境
source env-setup.sh

# 或重新安装工具链
sudo ./setup_toolchain.sh
```

### 问题: CMake配置失败

**解决方案:**
```bash
# 清理CMake缓存
rm -rf build-arm/CMakeCache.txt build-arm/CMakeFiles

# 重新配置
cd build-arm
cmake ..
```

### 问题: 依赖库缺失

**解决方案:**
```bash
# Ubuntu/Debian
sudo apt-get install build-essential cmake git

# CentOS/RHEL
sudo yum install gcc gcc-c++ make cmake git
```

## 📚 更多资源

- **验证脚本**: 运行 `./verify_qt_libs.sh` 查看详细配置
- **环境设置**: 查看 `env-setup.sh` 了解环境变量
- **工具脚本**: `tools/` 目录包含各种测试和辅助脚本
- **文档**: `docs/` 目录包含更多技术文档

## 💡 提示

1. **首次部署**: 使用 `quick_setup.sh` 一键完成所有配置
2. **日常开发**: 使用 `rebuild.sh` 快速重新编译
3. **更换机器**: 只需克隆仓库并运行 `quick_setup.sh`
4. **Qt库更新**: 如果需要更新Qt版本，修改 `copy_qt_libs.sh` 并重新运行
5. **工具链版本**: 如需使用不同版本，修改 `setup_toolchain.sh` 中的配置

## 🎉 成功标志

如果看到以下输出，说明部署成功：

```
==========================================
✓✓✓ 部署完成！ ✓✓✓
==========================================

构建信息:
  - 可执行文件: /path/to/build-arm/bin/QtImx6ullBackend
  - 构建目录: /path/to/build-arm
  - Qt库目录: /path/to/third_party/qt5/lib

✓ 所有Qt库配置正确！
```

现在你可以将项目部署到IMX6ULL设备上了！🚀

