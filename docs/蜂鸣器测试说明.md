# èœ‚é¸£å™¨æµ‹è¯•è¯´æ˜

## é—®é¢˜è¯Šæ–­ ğŸ”

å½“å‰ç³»ç»Ÿä¸­**èœ‚é¸£å™¨è®¾å¤‡ä¸å­˜åœ¨**ï¼Œå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š
- âŒ `/sys/class/leds/beep` ä¸å­˜åœ¨
- âŒ `DriverBeep::isAvailable()` è¿”å› `false`
- âŒ `SystemBeep`ã€`TimeService`ã€`AlarmService` æ— æ³•æ’­æ”¾æç¤ºéŸ³

## æµ‹è¯•æ­¥éª¤ âœ…

### æ–¹æ³•1ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼ˆæ¨èï¼‰

#### 1. åˆ›å»ºæ¨¡æ‹Ÿèœ‚é¸£å™¨è®¾å¤‡

```bash
sudo tools/setup_test_beep.sh
```

è¿™ä¼šåˆ›å»ºï¼š
- ç›®å½•ï¼š`/sys/class/leds/beep/`
- æ–‡ä»¶ï¼š`/sys/class/leds/beep/brightness`

#### 2. æµ‹è¯•SystemBeepå„ç§æç¤ºéŸ³

```bash
tools/test_system_beep.sh
```

è¿™ä¼šä¾æ¬¡æµ‹è¯•ï¼š
- ğŸ”” åˆå§‹åŒ–å®Œæˆæç¤ºéŸ³ï¼ˆæ»´æ»´ï¼‰
- ğŸ”” é…ç½®åŠ è½½æˆåŠŸï¼ˆæ»´ï¼‰
- ğŸ”” æˆåŠŸæç¤ºéŸ³ï¼ˆæ»´æ»´æ»´ï¼‰
- âš ï¸ è­¦å‘Šæç¤ºéŸ³ï¼ˆæ»´~æ»´~ï¼‰
- ğŸš¨ é”™è¯¯è­¦å‘ŠéŸ³ï¼ˆé•¿å“ï¼‰
- ğŸ”” å…³æœºæç¤ºéŸ³ï¼ˆæ»´æ»´æ»´æ»´ï¼‰

### æ–¹æ³•2ï¼šæ‰‹åŠ¨æµ‹è¯•

```bash
# 1. åˆ›å»ºè®¾å¤‡ï¼ˆéœ€è¦rootï¼‰
sudo mkdir -p /sys/class/leds/beep
sudo bash -c "echo 0 > /sys/class/leds/beep/brightness"
sudo chmod 666 /sys/class/leds/beep/brightness

# 2. æ‰‹åŠ¨æµ‹è¯•èœ‚é¸£ï¼ˆå†™å…¥255=å¼€ï¼Œ0=å…³ï¼‰
echo 255 > /sys/class/leds/beep/brightness  # å¼€å¯
sleep 0.5
echo 0 > /sys/class/leds/beep/brightness    # å…³é—­

# 3. æµ‹è¯•çŸ­ä¿ƒèœ‚é¸£2æ¬¡
for i in {1..2}; do
    echo 255 > /sys/class/leds/beep/brightness
    sleep 0.1
    echo 0 > /sys/class/leds/beep/brightness
    sleep 0.1
done
```

### æ–¹æ³•3ï¼šåœ¨ç¨‹åºä¸­æµ‹è¯•

é‡å¯ä½ çš„ä¸»ç¨‹åºï¼Œå®ƒä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨è°ƒç”¨ï¼š

```cpp
g_systemBeep = SystemBeep::getInstance();
if (g_systemBeep && g_systemBeep->isAvailable())
{
    g_systemBeep->playInitComplete();  // æ’­æ”¾"æ»´æ»´"æç¤ºéŸ³
}
```

## éªŒè¯ç»“æœ âœ…

### æˆåŠŸçš„æ ‡å¿—ï¼š
1. âœ… è®¾å¤‡æ–‡ä»¶å­˜åœ¨ï¼š`ls -la /sys/class/leds/beep/brightness`
2. âœ… å¯ä»¥æ‰‹åŠ¨æ§åˆ¶ï¼š`echo 255 > /sys/class/leds/beep/brightness`
3. âœ… ç¨‹åºæ—¥å¿—æ˜¾ç¤ºï¼š`[SystemBeep] ğŸ”” æ’­æ”¾åˆå§‹åŒ–å®Œæˆæç¤ºéŸ³ï¼ˆæ»´æ»´ï¼‰`
4. âœ… å®é™…å¬åˆ°èœ‚é¸£å£°ï¼ˆå¦‚æœç¡¬ä»¶è¿æ¥ï¼‰

### å¤±è´¥çš„æ ‡å¿—ï¼š
1. âŒ æ—¥å¿—æ˜¾ç¤ºï¼š`Beep device not found: /sys/class/leds/beep`
2. âŒ `isAvailable()` è¿”å› `false`
3. âŒ å¬ä¸åˆ°èœ‚é¸£å£°

## å®é™…ç¡¬ä»¶é…ç½® ğŸ”§

å¦‚æœä½ çš„IMX6ULLå¼€å‘æ¿æœ‰**çœŸå®èœ‚é¸£å™¨ç¡¬ä»¶**ï¼Œéœ€è¦é…ç½®å®é™…çš„GPIOï¼š

### 1. æŸ¥æ‰¾èœ‚é¸£å™¨GPIOç¼–å·

æ£€æŸ¥ç¡¬ä»¶æ–‡æ¡£ï¼Œèœ‚é¸£å™¨é€šå¸¸è¿æ¥åœ¨ç‰¹å®šGPIOä¸Šï¼Œä¾‹å¦‚ï¼š
- **GPIO1_19** â†’ ç¼–å· 19
- **GPIO5_1** â†’ ç¼–å· 129

### 2. å¯¼å‡ºGPIOå¹¶é…ç½®

```bash
# å‡è®¾èœ‚é¸£å™¨åœ¨GPIO19
echo 19 > /sys/class/gpio/export
echo out > /sys/class/gpio/gpio19/direction
echo 0 > /sys/class/gpio/gpio19/value

# æµ‹è¯•
echo 1 > /sys/class/gpio/gpio19/value  # å¼€å¯èœ‚é¸£å™¨
sleep 0.5
echo 0 > /sys/class/gpio/gpio19/value  # å…³é—­èœ‚é¸£å™¨
```

### 3. ä¿®æ”¹DriverBeepæ”¯æŒGPIOæ¨¡å¼

å¦‚æœéœ€è¦ä½¿ç”¨GPIOæ§åˆ¶ï¼Œä¿®æ”¹ `DriverBeep.cpp`ï¼š

```cpp
// æ·»åŠ GPIOæ¨¡å¼æ”¯æŒ
bool DriverBeep::writeBrightness(int value)
{
    // ä¼˜å…ˆå°è¯•LEDæ¨¡å¼
    QString ledPath = "/sys/class/leds/beep/brightness";
    if (QFile::exists(ledPath)) {
        // ä½¿ç”¨LEDæ¨¡å¼
        return writeToFile(ledPath, value);
    }
    
    // å›é€€åˆ°GPIOæ¨¡å¼
    QString gpioPath = "/sys/class/gpio/gpio19/value";
    if (QFile::exists(gpioPath)) {
        // ä½¿ç”¨GPIOæ¨¡å¼ï¼ˆ0æˆ–1ï¼‰
        return writeToFile(gpioPath, value > 0 ? 1 : 0);
    }
    
    return false;
}
```

## SystemBeep API å‚è€ƒ ğŸ“š

### å¯ç”¨çš„æç¤ºéŸ³æ–¹æ³•ï¼š

```cpp
SystemBeep *beep = SystemBeep::getInstance();

// 1. åˆå§‹åŒ–å®Œæˆï¼ˆæ»´æ»´ï¼‰
beep->playInitComplete();

// 2. é…ç½®åŠ è½½æˆåŠŸï¼ˆæ»´ï¼‰
beep->playConfigLoaded();

// 3. æˆåŠŸæç¤ºï¼ˆæ»´æ»´æ»´ï¼‰
beep->playSuccess();

// 4. è­¦å‘Šæç¤ºï¼ˆæ»´~æ»´~ï¼‰
beep->playWarning();

// 5. é”™è¯¯è­¦å‘Šï¼ˆé•¿å“ï¼‰
beep->playError();

// 6. å…³æœºæç¤ºï¼ˆæ»´æ»´æ»´æ»´ï¼‰
beep->playShutdown();

// 7. è‡ªå®šä¹‰æç¤ºéŸ³
beep->playCustom(3, 100, 150);  // 3æ¬¡ï¼Œæ¯æ¬¡100msï¼Œé—´éš”150ms

// 8. å¯ç”¨/ç¦ç”¨èœ‚é¸£å™¨
beep->setEnabled(false);  // ç¦ç”¨æ‰€æœ‰æç¤ºéŸ³
beep->setEnabled(true);   // å¯ç”¨

// 9. æ£€æŸ¥æ˜¯å¦å¯ç”¨
if (beep->isAvailable()) {
    qInfo() << "èœ‚é¸£å™¨å¯ç”¨";
}
```

## æ—¶é—´æœåŠ¡å’Œé—¹é’ŸæœåŠ¡çš„èœ‚é¸£å™¨ â°

ä¸€æ—¦èœ‚é¸£å™¨è®¾å¤‡å¯ç”¨ï¼Œä»¥ä¸‹åŠŸèƒ½ä¼šè‡ªåŠ¨å·¥ä½œï¼š

### TimeServiceï¼ˆæ—¶é—´æœåŠ¡ï¼‰
- â° **åŠç‚¹æé†’**ï¼šæ¯30åˆ†é’Ÿèœ‚é¸£1æ¬¡
- â° **æ•´ç‚¹æŠ¥æ—¶**ï¼šæ¯å°æ—¶èœ‚é¸£2æ¬¡

### AlarmServiceï¼ˆé—¹é’ŸæœåŠ¡ï¼‰
- ğŸŒ… **èµ·åºŠé—¹é’Ÿ**ï¼šå·¥ä½œæ—¥æ—©ä¸Š6:00ï¼ˆæœ‰èŠ‚å¥é“ƒå£°ï¼‰
- ğŸŒ™ **ç¡çœ æç¤º**ï¼šæ¯å¤©æ™šä¸Š22:00ï¼ˆæ¸©å’Œæç¤ºéŸ³ï¼‰

## æ•…éšœæ’æŸ¥ ğŸ”§

### é—®é¢˜1ï¼šè®¾å¤‡åˆ›å»ºåä»ç„¶ä¸å·¥ä½œ

```bash
# æ£€æŸ¥è®¾å¤‡æƒé™
ls -la /sys/class/leds/beep/
# åº”è¯¥æ˜¾ç¤º: -rw-rw-rw- brightness

# å¦‚æœæƒé™ä¸å¯¹ï¼Œä¿®å¤ï¼š
sudo chmod 666 /sys/class/leds/beep/brightness
```

### é—®é¢˜2ï¼šæ— æ³•åˆ›å»ºè®¾å¤‡ï¼ˆsysfsåªè¯»ï¼‰

åœ¨æŸäº›ç³»ç»Ÿä¸Šï¼Œ`/sys` æ˜¯åªè¯»çš„ã€‚è§£å†³æ–¹æ¡ˆï¼š
1. ä½¿ç”¨çœŸå®çš„GPIOè®¾å¤‡
2. ä¿®æ”¹DriverBeepæ”¯æŒGPIOæ¨¡å¼
3. ä½¿ç”¨è®¾å¤‡æ ‘é…ç½®å®é™…ç¡¬ä»¶

### é—®é¢˜3ï¼šå¬ä¸åˆ°å£°éŸ³ä½†è®¾å¤‡å­˜åœ¨

1. æ£€æŸ¥ç¡¬ä»¶è¿æ¥
2. æµ‹è¯•GPIOç›´æ¥æ§åˆ¶
3. æ£€æŸ¥èœ‚é¸£å™¨ç”µæº

## æµ‹è¯•æ¸…å• âœ…

å®Œæˆä»¥ä¸‹æµ‹è¯•ä»¥éªŒè¯èœ‚é¸£å™¨åŠŸèƒ½ï¼š

- [ ] è®¾å¤‡æ–‡ä»¶å­˜åœ¨ï¼š`/sys/class/leds/beep/brightness`
- [ ] æ‰‹åŠ¨æ§åˆ¶æˆåŠŸï¼š`echo 255 > /sys/class/leds/beep/brightness`
- [ ] SystemBeepå¯ç”¨ï¼š`isAvailable()` è¿”å› `true`
- [ ] å¯åŠ¨æç¤ºéŸ³å·¥ä½œï¼šç¨‹åºå¯åŠ¨æ—¶å¬åˆ°"æ»´æ»´"
- [ ] åŠç‚¹æé†’å·¥ä½œï¼šæ¯30åˆ†é’Ÿèœ‚é¸£
- [ ] èµ·åºŠé—¹é’Ÿå·¥ä½œï¼šå·¥ä½œæ—¥æ—©ä¸Š6:00å“é“ƒ
- [ ] ç¡çœ æç¤ºå·¥ä½œï¼šæ¯æ™š22:00æç¤º

---

**ä½œè€…**: Alex  
**æ—¥æœŸ**: 2025-10-15  
**ç›¸å…³æ–‡ä»¶**: 
- `src/core/SystemBeep.cpp`
- `src/drivers/beep/DriverBeep.cpp`
- `tools/setup_test_beep.sh`
- `tools/test_system_beep.sh`

